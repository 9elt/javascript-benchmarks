#!/bin/bash

sanitize() {
    echo -e "${@}" | sed "s/\`/\\\\\`/g"
}

# Generate the javascript benchmark code
#
# $1 => javascript snippet code
# $2 => normal distribution samples
# $3 => snippet measured iterations
# $4 => available code
# $5 => benchmark version: simple, realistic, edge-case
# $6 => benchmark name
# $7 => file path
benchmark() {
    echo "
    const _outliers = (array) => {
        let arr = [...array]
        arr.sort((a, b) => a - b)

        let q1 = arr[Math.floor((arr.length / 4))]; 
        let q3 = arr[Math.ceil((arr.length * (3 / 4)))];
        let iqr = q3 - q1;

        let max = q3 + iqr * 1.5
        let min = q1 - iqr * 1.5

        return arr.filter(x => x <= max && x >= min)
    }

    const _snd = (arr, adj) => {
        if (adj) {
            arr = arr.map(v => v - adj >= 0 ? v - adj : 0)
        }

        arr = _outliers(arr)

        const μ = arr.reduce((a, b) => a + b) / arr.length

        return {
            samples: arr.length,
            mean: μ,
            std: Math.sqrt(arr.map(x => Math.pow(x - μ, 2)).reduce((a, b) => a + b) / arr.length)
        }
    }

    $4

    const _benchmark_cost_results = [];

    for (let _i = 0; _i < $2 ; _i++) {
        const _start = performance.now();
        for (let _iter = 0; _iter < $3; _iter++) {}
        const _end = performance.now();
        _benchmark_cost_results.push(_end - _start);
    }

    let _benchmark_cost = _snd(_benchmark_cost_results);
    _benchmark_cost = _benchmark_cost.mean - _benchmark_cost.std;

    const _results = [];

    for (let _i = 0; _i < $2 ; _i++) {

        const _start = performance.now();

        for (let _iter = 0; _iter < $3; _iter++) {

            $1

        }

        const _end = performance.now();

        _results.push(_end - _start);
    }

    const _result = {
        version: '$5',
        name: '$6',
        file_path: '/$7',
        code: \`$( sanitize "$1" )\`,
        result: _snd(_results, _benchmark_cost),
    }

    console.clear();
    console.log(JSON.stringify(_result));"
}
