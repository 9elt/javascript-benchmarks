#!/bin/bash

source ./src/benchmark/utils
source ./src/benchmark/metadata
source ./src/benchmark/wrapper

run() {
# base benchmark directory
BASE_DIR="benchmarks"

# benchmark directory
BENCHMARK_DIR="$BASE_DIR/$1"

BENCHMARK_NAME=$( parse_dirname "$BENCHMARK_DIR" )

BENCHMARK_NAME_FORM="$( space "$BENCHMARK_NAME" " " )"
echo -e "\nrunning $( cyan "${BENCHMARK_NAME_FORM^}" )\n"

# load benchmark config
source $( load_config_or_exit "$BENCHMARK_DIR" )

# check for available code
available_code_or_exit "$BENCHMARK_DIR"

# javascript files in directory
SNIPPETS=("$BENCHMARK_DIR"/*.js)
SNIPPET_NAMES=()
SNIPPET_NAMES=()

VERSIONS=("simple" "realistic" "edge-case")

RESULTS_simple=()
RESULTS_realistic=()
RESULTS_edge_case=()

RESULTS=()

TESTS=$( cat "$BENCHMARK_DIR/.code/tests.js" )

for SNIPPET in ${SNIPPETS[@]}
do

    CODE=$( cat "$SNIPPET" )

    NAME=$( parse_filename "$SNIPPET" "_" )
    SNIPPET_NAMES+=("$( parse_filename "$SNIPPET" )")

    for VERSION in ${VERSIONS[@]}
    do

        show_progress "$( parse_filename "$SNIPPET" " " )" "$VERSION"

        # parse available code
        AVAILABLE_CODE=$( cat "$BENCHMARK_DIR/.code/$VERSION.js" )

        BENCHMARK=$( 
            benchmark "$CODE" "$AVAILABLE_CODE" "$TESTS" "$SAMPLES" "$ITERATIONS" "$( space $VERSION "_" )" "$NAME" "$SNIPPET"
        )

        RESULT=$( node -e "$BENCHMARK" )

        RESULTS+=("$RESULT")
    done

    show_progress "$NAME"

done

echo ""

CONF="{
    \"name\": \"$( space $BENCHMARK_NAME "_" )\",
    \"description\": \"$DESCRIPTION\",
    \"related\": \"$RELATED\",
    \"samples\": $SAMPLES,
    \"iterations\": "$ITERATIONS"
}"

JSON_RESULT=$( node ./src/js/to-json.mjs "$CONF" "$MEDATADA" "${RESULTS[@]}" )

if [[ ! -d "$BENCHMARK_DIR/.data" ]]
then
    mkdir "$BENCHMARK_DIR/.data"
fi

echo "$JSON_RESULT" > "$BENCHMARK_DIR/.data/results.json"

echo "$( node ./src/js/chart.mjs "$JSON_RESULT" )" > "$BENCHMARK_DIR/.data/chart.svg"


echo "$( node ./src/js/readme.mjs "$JSON_RESULT" )" > "$BENCHMARK_DIR/README.md"
}