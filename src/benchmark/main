#!/bin/bash

source ./src/benchmark/utils
source ./src/benchmark/metadata
source ./src/benchmark/wrapper

run() {
    # base benchmark directory
    BASE_DIR="benchmarks"

    # benchmark directory
    BENCHMARK_DIR="$BASE_DIR/$1"

    BENCHMARK_NAME=$(parse_dirname "$BENCHMARK_DIR")

    BENCHMARK_NAME_FORM="$(space "$BENCHMARK_NAME" " ")"
    echo -e "\nrunning $(cyan "${BENCHMARK_NAME_FORM^}")\n"

    # load benchmark config
    source "$(load_config_or_exit "$BENCHMARK_DIR")"

    CONF=(
        "name" "$(space "$BENCHMARK_NAME" "_")"
        "description" "$DESCRIPTION"
        "related" "$RELATED"
        "samples" "$SAMPLES"
        "iterations" "$ITERATIONS"
    )

    JSON_CONFIG=$(to_json "${CONF[@]}")

    # check for available code
    available_code_or_exit "$BENCHMARK_DIR"

    # javascript files in directory
    SNIPPETS=("$BENCHMARK_DIR"/*.js)
    SNIPPET_NAMES=()
    SNIPPET_NAMES=()

    VERSIONS=("simple" "realistic" "edge-case")

    RESULTS=()

    TESTS=$(cat "$BENCHMARK_DIR/.code/tests.js")
    i=0

    for SNIPPET in "${SNIPPETS[@]}"; do

        CODE=$(cat "$SNIPPET")

        NAME=$(parse_filename "$SNIPPET" "_")
        SNIPPET_NAMES+=("$(parse_filename "$SNIPPET")")

        for VERSION in "${VERSIONS[@]}"; do

            RES="$(node ./src/js/single-result.mjs "$JSON_CONFIG" "${RESULTS[@]}")"
            IFS=',' read -r -a PARTIAL <<<"$RES"
            show_progress "$(parse_filename "$SNIPPET" " ")" "$VERSION" "$i"

            # parse available code
            AVAILABLE_CODE=$(cat "$BENCHMARK_DIR/.code/$VERSION.js")

            BENCHMARK=$(
                benchmark "$CODE" "$AVAILABLE_CODE" "$TESTS" "$SAMPLES" "$ITERATIONS" "$(space "$VERSION" "_")" "$NAME" "$SNIPPET"
            )

            RESULTS+=("$(node -e "$BENCHMARK")")

        done

        RES="$(node ./src/js/single-result.mjs "$JSON_CONFIG" "${RESULTS[@]}")"
        IFS=',' read -r -a PARTIAL <<<"$RES"
        show_progress "$(parse_filename "$SNIPPET" " ")" "done" "$i"

        ((i += 3))

    done

    echo ""

    METADATA=$(parse_metadata)

    JSON_RESULT=$(node ./src/js/results-to-json.mjs "$JSON_CONFIG" "$METADATA" "${RESULTS[@]}")

    create_dir_if_not_exists "$BENCHMARK_DIR/.data"

    echo "$JSON_RESULT" >"$BENCHMARK_DIR/.data/results.json"

    node ./src/js/chart.mjs "$JSON_RESULT" >"$BENCHMARK_DIR/.data/chart.svg"
    node ./src/js/readme.mjs "$JSON_RESULT" >"$BENCHMARK_DIR/README.md"
}
